<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="favicon.jpg">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <style>
    * {
      font-family: 'Montserrat', sans-serif;
      box-sizing: border-box;
      outline: none;
    }
    html {
      scroll-behavior: smooth;
    }
    textarea {
      min-height: 100px;
    }
    .point-number {
      width: 28px;
      height: 28px;
      line-height: 28px;
    }
    .slide-menu {
      position: fixed;
      top: 0;
      right: -100%;
      width: 80%;
      max-width: 350px;
      height: 100%;
      background-color: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      transition: right 0.3s ease-in-out;
      z-index: 50;
      padding: 1rem;
      overflow-y: auto;
    }
    .slide-menu.open {
      right: 0;
    }
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      display: none;
    }
    .menu-overlay.open {
      display: block;
    }
    .share-options-menu {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 60;
      padding: 1rem;
      width: 90%;
      max-width: 300px;
      display: none;
    }
    .share-options-menu.open {
      display: block;
    }
    .verse-text-display {
      font-size: 0.9rem;
      color: #475569; /* slate-600 */
      margin-top: 0.25rem;
      padding-left: 0.75rem;
      border-left: 2px solid #c7d2fe; /* indigo-200 */
    }
  </style>
  <title>Apuntes | IBBV</title>
</head>
<body class="bg-gray-100 text-gray-800">

  <div id="slide-menu" class="slide-menu">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-indigo-800">Prédicas Guardadas</h3>
      <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800">
        <span class="iconify text-2xl" data-icon="clarity:close-line"></span>
      </button>
    </div>
    <ul id="prédicas-guardadas-lista" class="space-y-2"></ul>
    <div class="text-center mt-6">
      <button id="limpiar-todo-btn" class="text-red-500 hover:text-red-700 text-sm">Limpiar todas las prédicas</button>
    </div>
  </div>
  <div id="menu-overlay" class="menu-overlay"></div>

  <div class="container mx-auto p-4 md:p-8" id="prédica-content">
    
    <header class="bg-white rounded-xl shadow-lg p-6 mb-8 text-center relative">
      <button id="open-menu-btn" class="absolute top-4 right-4 text-gray-500 hover:text-indigo-700">
        <span class="iconify text-3xl" data-icon="mdi:bookmark-outline"></span>
      </button>
      <h1 class="text-3xl md:text-4xl font-bold text-indigo-800 mb-2">
        <input type="text" id="prédica-título" placeholder="Título de la Prédica" class="w-full text-center bg-transparent p-2 rounded-md font-bold text-2xl md:text-3xl text-indigo-800 focus:bg-gray-100">
      </h1>
      <p class="text-lg text-gray-600">Por: <input type="text" id="predicador-nombre" placeholder="Nombre del Predicador" class="bg-transparent p-1 rounded-md text-gray-600 text-base md:text-lg text-center font-semibold focus:bg-gray-100"></p>
      <div class="flex flex-col items-center text-gray-500 mt-3 text-sm space-y-1">
        <div class="flex items-center">
          <span class="iconify mr-2" data-icon="clarity:date-line"></span>
          <span id="fecha-actual"></span>
        </div>
        <div class="flex items-center">
          <span class="iconify mr-2" data-icon="ic:baseline-watch-line"></span>
          <span id="hora-actual"></span>
        </div>
        <div class="flex items-center">
          <span class="iconify mr-2" data-icon="ic:baseline-location-on"></span>
          <span>Iglesia Bíblica Bautista La Verdad</span>
        </div>
      </div>
    </header>

    <section class="grid md:grid-cols-2 gap-8 mb-8">
      <div class="bg-white rounded-xl shadow-lg p-6 flex items-center justify-center">
        <div class="text-center w-full">
          <p class="text-gray-500 text-sm mb-2 uppercase tracking-wide font-semibold">Versículo Principal</p>
          <input type="text" id="pasaje-principal" placeholder="Juan 3:16" class="w-full text-center bg-gray-100 p-2 rounded-md font-bold text-xl md:text-2xl text-gray-900 mb-2">
          <textarea id="cita-pasaje" placeholder="El texto del versículo aparecerá aquí..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center"><span class="iconify mr-2 text-2xl" data-icon="clarity:list-line"></span> Datos de la Prédica</h2>
        <ul id="puntos-lista" class="space-y-4"></ul>
        <div class="flex gap-4 mt-4">
          <button id="añadir-punto" class="flex-grow bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300">
            Añadir Dato
          </button>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center"><span class="iconify mr-2" data-icon="clarity:link-line"></span> Versículos Citados</h2>
      <ul id="versículos-citados-lista" class="space-y-4"></ul>
      <button id="añadir-versiculo" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300">
        Añadir Versículo
      </button>
    </section>

    <section class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center"><span class="iconify mr-2" data-icon="clarity:search-line"></span> Buscando la Profundidad</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-indigo-700 mb-2 flex items-center"><span class="iconify mr-2" data-icon="clarity:book-line"></span> Situación</h3>
          <p class="text-gray-600 text-sm mb-4">Anota detalles del contexto del pasaje: ¿A quién se le escribió y por qué? ¿Qué estaba pasando en ese tiempo?</p>
          <textarea id="situación-texto" placeholder="Ej: Este evangelio fue escrito para los judíos y griegos..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-indigo-700 mb-2 flex items-center"><span class="iconify mr-2" data-icon="clarity:link-line"></span> Historias Relacionadas</h3>
          <p class="text-gray-600 text-sm mb-4">Vincula este pasaje con otros versículos o historias de la Biblia que hablen de temas similares.</p>
          <textarea id="historias-texto" placeholder="Ej: Conectar Juan 3:16 con Romanos 5:8..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-indigo-700 mb-2 flex items-center"><span class="iconify mr-2" data-icon="clarity:star-line"></span> La Cosecha de la Verdad</h3>
          <p class="text-gray-600 text-sm mb-4">Reflexiona sobre cómo esta verdad bíblica se manifiesta en tu vida y en la vida de los creyentes.</p>
          <textarea id="cosecha-texto" placeholder="Ej: La cosecha es la seguridad de la salvación eterna..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center"><span class="iconify mr-2" data-icon="clarity:pencil-line"></span> Conclusión</h2>
      <div class="space-y-6">
        <div>
          <p class="font-semibold text-gray-900 mb-1">¿Qué es lo más importante que Dios me está diciendo en esta prédica?</p>
          <textarea id="pregunta1-texto" placeholder="Ej: El amor de Dios es incondicional..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
        <div>
          <p class="font-semibold text-gray-900 mb-1">¿Cómo debo aplicar esta verdad en mi vida esta semana?</p>
          <textarea id="pregunta2-texto" placeholder="Ej: Orar por mis seres queridos..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
        <div>
          <p class="font-semibold text-gray-900 mb-1">¿Con quién puedo compartir esta enseñanza?</p>
          <textarea id="pregunta3-texto" placeholder="Ej: Con mi amigo de la universidad..." class="w-full bg-gray-100 p-2 rounded-md text-gray-700"></textarea>
        </div>
      </div>
    </section>

    <section class="p-4 flex justify-between space-x-4 mb-16">
      <button id="nueva-prédica-btn" class="flex-grow flex items-center justify-center space-x-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">
        <span class="iconify text-2xl" data-icon="mdi:plus"></span>
      </button>
      <button id="btn-evangelizar" class="flex-grow flex items-center justify-center space-x-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">
        <span class="iconify text-2xl" data-icon="mdi:share-variant-outline"></span>
      </button>
    </section>
  </div>

  <div id="share-options-menu" class="share-options-menu">
    <div class="flex justify-between items-center mb-4">
      <h4 class="text-lg font-bold text-gray-800">Selecciona el tipo de mensaje</h4>
      <button id="close-share-menu-btn" class="text-gray-500 hover:text-gray-800">
        <span class="iconify text-2xl" data-icon="clarity:close-line"></span>
      </button>
    </div>
    <ul class="space-y-3">
      <li>
        <button id="share-evangelizacion" class="flex items-center w-full p-3 bg-gray-100 rounded-md hover:bg-indigo-100 transition-colors">
          <span class="iconify text-xl text-indigo-600 mr-3" data-icon="ic:round-format-quote"></span>
          <span class="font-semibold text-gray-800">Evangelización</span>
        </button>
      </li>
      <li>
        <button id="share-guia" class="flex items-center w-full p-3 bg-gray-100 rounded-md hover:bg-indigo-100 transition-colors">
          <span class="iconify text-xl text-indigo-600 mr-3" data-icon="mdi:book-open-outline"></span>
          <span class="font-semibold text-gray-800">Guía para prédicar</span>
        </button>
      </li>
      <li>
        <button id="share-estudio" class="flex items-center w-full p-3 bg-gray-100 rounded-md hover:bg-indigo-100 transition-colors">
          <span class="iconify text-xl text-indigo-600 mr-3" data-icon="mdi:text-box-search-outline"></span>
          <span class="font-semibold text-gray-800">Estudio de Prédica</span>
        </button>
      </li>
    </ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      const prédicaContent = document.getElementById('prédica-content');
      const slideMenu = document.getElementById('slide-menu');
      const openMenuBtn = document.getElementById('open-menu-btn');
      const closeMenuBtn = document.getElementById('close-menu-btn');
      const menuOverlay = document.getElementById('menu-overlay');
      const listaPrédicasGuardadas = document.getElementById('prédicas-guardadas-lista');
      const btnLimpiarTodo = document.getElementById('limpiar-todo-btn');
      
      const books = [
        { name: "Genesis", abrev: "GN" }, { name: "Exodo", abrev: "EX" }, { name: "Levitico", abrev: "LV" },
        { name: "Numeros", abrev: "NM" }, { name: "Deuteronomio", abrev: "DT" }, { name: "Josue", abrev: "JOS" },
        { name: "Jueces", abrev: "JUE" }, { name: "Rut", abrev: "RT" }, { name: "1-Samuel", abrev: "1S" },
        { name: "2-Samuel", abrev: "2S" }, { name: "1-Reyes", abrev: "1R" }, { name: "2-Reyes", abrev: "2R" },
        { name: "1-Cronicas", abrev: "1CR" }, { name: "2-Cronicas", abrev: "2CR" }, { name: "Esdras", abrev: "ESD" },
        { name: "Nehemias", abrev: "NEH" }, { name: "Ester", abrev: "EST" }, { name: "Job", abrev: "JOB" },
        { name: "Salmos", abrev: "SAL" }, { name: "Proverbios", abrev: "PR" }, { name: "Eclesiastes", abrev: "EC" },
        { name: "Cantares", abrev: "CNT" }, { name: "Isaias", abrev: "IS" }, { name: "Jeremias", abrev: "JER" },
        { name: "Lamentaciones", abrev: "LM" }, { name: "Ezequiel", abrev: "EZ" }, { name: "Daniel", abrev: "DN" },
        { name: "Oseas", abrev: "OS" }, { name: "Joel", abrev: "JL" }, { name: "Amos", abrev: "AM" },
        { name: "Abdias", abrev: "ABD" }, { name: "Jonas", abrev: "JON" }, { name: "Miqueas", abrev: "MI" },
        { name: "Nahum", abrev: "NAH" }, { name: "Habacuc", abrev: "HAB" }, { name: "Sofonias", abrev: "SOF" },
        { name: "Hageo", abrev: "HAG" }, { name: "Zacarias", abrev: "ZAC" }, { name: "Malaquias", abrev: "MAL" },
        { name: "Mateo", abrev: "MT" }, { name: "Marcos", abrev: "MR" }, { name: "Lucas", abrev: "LC" },
        { name: "Juan", abrev: "JN" }, { name: "Hechos", abrev: "HCH" }, { name: "Romanos", abrev: "RO" },
        { name: "1-Corintios", abrev: "1CO" }, { name: "2-Corintios", abrev: "2CO" }, { name: "Galatas", abrev: "GA" },
        { name: "Efesios", abrev: "EF" }, { name: "Filipenses", abrev: "FIL" }, { name: "Colosenses", abrev: "COL" },
        { name: "1-Tesalonicenses", abrev: "1TS" }, { name: "2-Tesalonicenses", abrev: "2TS" },
        { name: "1-Timoteo", abrev: "1TI" }, { name: "2-Timoteo", abrev: "2TI" }, { name: "Tito", abrev: "TIT" },
        { name: "Filemon", abrev: "FLM" }, { name: "Hebreos", abrev: "HE" }, { name: "Santiago", abrev: "STG" },
        { name: "1-Pedro", abrev: "1P" }, { name: "2-Pedro", abrev: "2P" }, { name: "1-Juan", abrev: "1JN" },
        { name: "2-Juan", abrev: "2JN" }, { name: "3-Juan", abrev: "3JN" }, { name: "Judas", abrev: "JUD" },
        { name: "Apocalipsis", abrev: "AP" }
      ];

      function findBookAbrev(bookName) {
        const normalizedName = bookName.toLowerCase().replace(/[\s-]/g, '');
        for (const book of books) {
          const normalizedBookName = book.name.toLowerCase().replace(/[\s-]/g, '');
          if (normalizedBookName.includes(normalizedName)) {
            return book.abrev;
          }
        }
        return null;
      }

      function parseInput(input) {
        const regex = /(.+?)\s*(\d+):(\d+)(?:-(\d+))?$/i;
        const match = input.trim().match(regex);
        if (match) {
          const bookName = match[1].trim();
          const chapter = match[2];
          const verse = match[3];
          const verseEnd = match[4];
          return { book: bookName, chapter, verse, verseEnd };
        }
        return null;
      }
      
      // ==================================================================
      // ========= FUNCIÓN CORREGIDA ======================================
      // ==================================================================
      async function fetchVerseData(reference) {
          const trimmedRef = reference.trim();
          if (!trimmedRef) return null;

          try {
              const parsed = parseInput(trimmedRef);
              if (!parsed) { throw new Error('Formato de referencia inválido.'); }

              const bookAbrev = findBookAbrev(parsed.book);
              if (!bookAbrev) { throw new Error(`Libro no encontrado: ${parsed.book}`); }

              let verseRange = parsed.verse;
              if (parsed.verseEnd) {
                  verseRange += `-${parsed.verseEnd}`;
              }

              const url = `https://bible-api.deno.dev/api/read/rv1960/${bookAbrev}/${parsed.chapter}/${verseRange}`;
              const response = await fetch(url);
              
              if (!response.ok) {
                  const error = await response.json();
                  throw new Error(error.message || 'Error en la API');
              }

              const data = await response.json();

              // ¡AQUÍ ESTÁ LA CORRECCIÓN DEFINITIVA!
              // Si la 'data' no es un array (es un solo objeto), la envolvemos en un array.
              // Si es un array, la usamos tal cual.
              const dataAsArray = Array.isArray(data) ? data : [data];
              
              if (dataAsArray.length === 0) { throw new Error('Versículo no encontrado.'); }
              
              return dataAsArray; // Ahora estamos 100% seguros de que devolvemos un array.

          } catch (error) {
              console.error(`Error al buscar "${trimmedRef}":`, error);
              return null;
          }
      }

      const pasajePrincipalInput = document.getElementById('pasaje-principal');
      const citaPasajeTextarea = document.getElementById('cita-pasaje');

      pasajePrincipalInput.addEventListener('blur', async () => {
          citaPasajeTextarea.value = 'Buscando...';
          const data = await fetchVerseData(pasajePrincipalInput.value);
          if (data) {
              citaPasajeTextarea.value = data.map(v => v.verse).join(' ');
              saveToLocalStorage();
          } else {
              citaPasajeTextarea.value = 'No se pudo encontrar el versículo. Revisa la referencia.';
          }
      });

      const openMenu = () => {
        slideMenu.classList.add('open');
        menuOverlay.classList.add('open');
      };
      const closeMenu = () => {
        slideMenu.classList.remove('open');
        menuOverlay.classList.remove('open');
      };

      openMenuBtn.addEventListener('click', openMenu);
      closeMenuBtn.addEventListener('click', closeMenu);
      menuOverlay.addEventListener('click', closeMenu);
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' && !slideMenu.classList.contains('open')) {
          openMenu();
        }
      });
      
      let touchStartX = 0;
      let touchEndX = 0;
      prédicaContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });
      prédicaContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        if (touchEndX - touchStartX > 100 && !slideMenu.classList.contains('open')) {
          openMenu();
        } else if (touchStartX - touchEndX > 100 && slideMenu.classList.contains('open')) {
          closeMenu();
        }
      });

      const getFormattedContentGuia = () => {
        const title = document.getElementById('prédica-título').value || 'Título no especificado';
        const predicador = document.getElementById('predicador-nombre').value || 'Anónimo';
        const fecha = document.getElementById('fecha-actual').textContent;
        const versiculoPrincipal = document.getElementById('pasaje-principal').value || 'Versículo no especificado';
        const citaPrincipal = document.getElementById('cita-pasaje').value || 'Cita no especificada';
        const datos = Array.from(document.querySelectorAll('#puntos-lista input')).map(input => input.value).filter(val => val.trim() !== '');
        const situacion = document.getElementById('situación-texto').value;
        const historias = document.getElementById('historias-texto').value;
        const cosecha = document.getElementById('cosecha-texto').value;
        const pregunta1 = document.getElementById('pregunta1-texto').value;
        
        let text = `*Guía para Predicar: "${title}"*\n\n`;
        text += `*Predicador:* ${predicador}\n`;
        text += `*Fecha:* ${fecha}\n\n`;
        text += `--- *Inicio de la Prédica* ---\n\n`;
        text += `*Introducción:* Puedes comenzar con una pregunta o una anécdota que se conecte con el tema de la prédica. Luego, presenta el versículo base.\n\n`;
        text += `*Versículo Principal:* ${versiculoPrincipal}\n`;
        text += `_"${citaPrincipal}"_\n\n`;
        text += `*Contexto (Situación):* Explica brevemente el trasfondo de este versículo. ¿A quién se le escribió y por qué era importante para ellos? (_Apunte: ${situacion}_)\n`;
        
        if (datos.length > 0) {
            text += `\n*Puntos Clave:* Aquí puedes desarrollar los siguientes puntos para tu prédica:\n`;
            datos.forEach((dato, index) => {
                if (dato) text += `\n  - *Punto ${index + 1}:* ${dato}\n`;
            });
        }
        
        text += `\n*Conexiones (Historias Relacionadas):* Fortalece tu mensaje con versículos o historias de la Biblia que refuercen estos puntos. (_Apunte: ${historias}_)\n`;
        text += `\n*Aplicación (La Cosecha de la Verdad):* ¿Cómo se aplica esta verdad en nuestras vidas hoy? Muestra cómo la gente puede vivir este mensaje. (_Apunte: ${cosecha}_)\n`;
        text += `\n*Cierre:* Concluye con un llamado a la acción. ¿Qué es lo más importante que se debe recordar? (_Apunte: ${pregunta1}_)\n\n`;
        text += `--- *Fin de la Prédica* ---\n\n`;
        text += `¡Que Dios te use poderosamente!`;
        
        return encodeURIComponent(text);
      };

      const getFormattedContentEvangelizacion = () => {
        const title = document.getElementById('prédica-título').value || 'Prédica de Hoy';
        const versiculoPrincipal = document.getElementById('pasaje-principal').value || 'Juan 3:16';
        const citaPrincipal = document.getElementById('cita-pasaje').value || 'Porque de tal manera amó Dios al mundo, que ha dado a su Hijo unigénito, para que todo aquel que en él cree, no se pierda, mas tenga vida eterna.';
        
        const text = `¡Hola! Quería compartirte un mensaje que me impactó hoy.\n\nLa prédica de hoy se basó en el pasaje de *${versiculoPrincipal}*\n\n_"${citaPrincipal}"_\n\nMe hizo reflexionar sobre el amor de Dios. Si quieres saber más, no dudes en preguntarme. ¡Bendiciones!`;
        return encodeURIComponent(text);
      };

      const getFormattedContentEstudio = () => {
        const title = document.getElementById('prédica-título').value || 'Estudio de Prédica';
        const predicador = document.getElementById('predicador-nombre').value || 'Anónimo';
        const fecha = document.getElementById('fecha-actual').textContent;
        const versiculoPrincipal = document.getElementById('pasaje-principal').value || 'Versículo no especificado';
        const pregunta1 = document.getElementById('pregunta1-texto').value || '¿Qué es lo más importante que Dios me está diciendo en esta prédica?';
        const pregunta2 = document.getElementById('pregunta2-texto').value || '¿Cómo debo aplicar esta verdad en mi vida esta semana?';
        const pregunta3 = document.getElementById('pregunta3-texto').value || '¿Con quién puedo compartir esta enseñanza?';

        let text = `*Estudio de Prédica: "${title}"*\n\n`;
        text += `*Basado en:* ${versiculoPrincipal}\n\n`;
        text += `--- *Para Reflexionar* ---\n\n`;
        text += `1. *¿Qué es lo más importante?*\n${pregunta1}\n\n`;
        text += `2. *¿Cómo lo aplico?*\n${pregunta2}\n\n`;
        text += `3. *¿Con quién lo comparto?*\n${pregunta3}\n`;
        
        return encodeURIComponent(text);
      };
      
      const saveToLocalStorage = () => {
        const versiculosData = [];
        document.querySelectorAll('#versículos-citados-lista li').forEach(li => {
            const input = li.querySelector('input');
            const textDiv = li.querySelector('.verse-text-display');
            if (input) {
                versiculosData.push({
                    ref: input.value,
                    text: textDiv ? textDiv.innerHTML : ''
                });
            }
        });

        const data = {
            title: document.getElementById('prédica-título').value,
            predicador: document.getElementById('predicador-nombre').value,
            pasajePrincipal: document.getElementById('pasaje-principal').value,
            citaPasaje: document.getElementById('cita-pasaje').value,
            puntos: Array.from(document.querySelectorAll('#puntos-lista input')).map(input => input.value),
            versiculos: versiculosData,
            situacion: document.getElementById('situación-texto').value,
            historias: document.getElementById('historias-texto').value,
            cosecha: document.getElementById('cosecha-texto').value,
            pregunta1: document.getElementById('pregunta1-texto').value,
            pregunta2: document.getElementById('pregunta2-texto').value,
            pregunta3: document.getElementById('pregunta3-texto').value
        };
        localStorage.setItem('currentPrédicaData', JSON.stringify(data));
      };

      const loadFromLocalStorage = () => {
        const data = JSON.parse(localStorage.getItem('currentPrédicaData'));
        if (data) {
          fillForm(data);
        } else {
          clearForm();
        }
      };

      const clearForm = () => {
        prédicaContent.querySelectorAll('input[type="text"], textarea').forEach(input => input.value = '');
        document.getElementById('puntos-lista').innerHTML = '';
        document.getElementById('versículos-citados-lista').innerHTML = '';
        crearNuevoPunto();
        crearNuevoVersiculo();
        saveToLocalStorage();
      };
      
      const savePrédica = () => {
        const title = document.getElementById('prédica-título').value.trim() || 'Sin Título';
        const date = document.getElementById('fecha-actual').textContent;
        const key = `prédica-${title}-${date}-${Date.now()}`;
        saveToLocalStorage(); 
        const currentData = localStorage.getItem('currentPrédicaData');
        
        if (currentData) {
            const dataToSave = JSON.parse(currentData);
            dataToSave.title = title;
            dataToSave.date = date;
            localStorage.setItem(key, JSON.stringify(dataToSave));
            updatePrédicasMenu();
        }
      };
      
      const fillForm = (data) => {
        document.getElementById('prédica-título').value = data.title || '';
        document.getElementById('predicador-nombre').value = data.predicador || '';
        document.getElementById('pasaje-principal').value = data.pasajePrincipal || '';
        document.getElementById('cita-pasaje').value = data.citaPasaje || '';
        document.getElementById('situación-texto').value = data.situacion || '';
        document.getElementById('historias-texto').value = data.historias || '';
        document.getElementById('cosecha-texto').value = data.cosecha || '';
        document.getElementById('pregunta1-texto').value = data.pregunta1 || '';
        document.getElementById('pregunta2-texto').value = data.pregunta2 || '';
        document.getElementById('pregunta3-texto').value = data.pregunta3 || '';
        
        listaPuntos.innerHTML = '';
        if (data.puntos && data.puntos.length > 0) {
            data.puntos.forEach(value => crearNuevoPunto(value));
        } else {
            crearNuevoPunto();
        }

        listaVersículos.innerHTML = '';
        if (data.versiculos && data.versiculos.length > 0) {
            data.versiculos.forEach(v => crearNuevoVersiculo(v.ref, v.text));
        } else {
            crearNuevoVersiculo();
        }
      };

      const updatePrédicasMenu = () => {
        listaPrédicasGuardadas.innerHTML = '';
        const prédicas = Object.keys(localStorage).filter(key => key.startsWith('prédica-'));
        if (prédicas.length === 0) {
          listaPrédicasGuardadas.innerHTML = '<li class="text-gray-500 text-center text-sm">No hay prédicas guardadas.</li>';
          btnLimpiarTodo.style.display = 'none';
        } else {
          btnLimpiarTodo.style.display = 'block';
          prédicas.forEach(key => {
            const data = JSON.parse(localStorage.getItem(key));
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md hover:bg-gray-200 transition-colors cursor-pointer';
            li.dataset.key = key;
            li.innerHTML = `
              <div class="flex-grow" data-key="${key}">
                <p class="font-semibold text-gray-800">${data.title}</p>
                <p class="text-sm text-gray-500">${data.date}</p>
              </div>
              <button class="eliminar-prédica text-red-400 hover:text-red-600 ml-4">
                <span class="iconify" data-icon="material-symbols:delete-forever-rounded"></span>
              </button>
            `;
            listaPrédicasGuardadas.appendChild(li);
          });
        }
      };

      listaPrédicasGuardadas.addEventListener('click', (e) => {
        const target = e.target.closest('li div[data-key]');
        const deleteButton = e.target.closest('.eliminar-prédica');
        
        if (target) {
          const key = target.dataset.key;
          const data = JSON.parse(localStorage.getItem(key));
          if (data) {
            fillForm(data);
            localStorage.setItem('currentPrédicaData', JSON.stringify(data));
            closeMenu();
          }
        } else if (deleteButton) {
          const key = deleteButton.closest('li').dataset.key;
          localStorage.removeItem(key);
          updatePrédicasMenu();
        }
      });
      
      btnLimpiarTodo.addEventListener('click', () => {
        if (confirm('¿Estás seguro de que quieres eliminar TODAS las prédicas guardadas? Esta acción no se puede deshacer.')) {
          Object.keys(localStorage).filter(key => key.startsWith('prédica-')).forEach(key => {
            localStorage.removeItem(key);
          });
          updatePrédicasMenu();
        }
      });

      const fechaElement = document.getElementById('fecha-actual');
      const horaElement = document.getElementById('hora-actual');
      const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
      const opcionesHora = { hour: '2-digit', minute: '2-digit' };
      
      const ahora = new Date();
      fechaElement.textContent = ahora.toLocaleDateString('es-ES', opcionesFecha);
      horaElement.textContent = ahora.toLocaleTimeString('es-ES', opcionesHora);

      const listaPuntos = document.getElementById('puntos-lista');
      const botónAñadirPunto = document.getElementById('añadir-punto');
      let contadorPuntos = 0;
      const coloresMarcador = ['bg-red-500/30', 'bg-blue-500/30', 'bg-green-500/30', 'bg-yellow-500/30', 'bg-purple-500/30', 'bg-pink-500/30'];

      const crearNuevoPunto = (value = '') => {
        contadorPuntos++;
        const nuevoPunto = document.createElement('li');
        nuevoPunto.className = 'flex items-center group relative';
        nuevoPunto.innerHTML = `
          <div class="relative w-full">
            <input type="text" placeholder="Escribe aquí el dato de la prédica..." class="w-full text-gray-800 p-2 pr-12 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="${value}">
            <span class="point-number-text absolute right-12 top-1/2 -translate-y-1/2 text-gray-600 font-bold text-sm">[${contadorPuntos}]</span>
            <button class="eliminar-punto absolute right-3 top-1/2 -translate-y-1/2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">
              <span class="iconify text-xl" data-icon="material-symbols:delete-forever-rounded"></span>
            </button>
          </div>
        `;
        listaPuntos.appendChild(nuevoPunto);
        reordenarPuntos();
      };

      const reordenarPuntos = () => {
        const puntos = listaPuntos.querySelectorAll('li');
        puntos.forEach((punto, index) => {
          punto.querySelector('.point-number-text').textContent = `[${index + 1}]`;
          const input = punto.querySelector('input[type="text"]');
          input.className = `w-full text-gray-800 p-2 pr-12 rounded-md ${coloresMarcador[index % coloresMarcador.length]} focus:outline-none focus:ring-2 focus:ring-indigo-500`;
        });
        contadorPuntos = puntos.length;
        saveToLocalStorage();
      };

      listaPuntos.addEventListener('click', (e) => {
        if (e.target.closest('.eliminar-punto')) {
          e.target.closest('li').remove();
          reordenarPuntos();
        }
      });
      
      botónAñadirPunto.addEventListener('click', () => {
        crearNuevoPunto();
        saveToLocalStorage();
      });

      const listaVersículos = document.getElementById('versículos-citados-lista');
      const botónAñadirVersiculo = document.getElementById('añadir-versiculo');

      const crearNuevoVersiculo = (refValue = '', textValue = '') => {
          const nuevoVersiculo = document.createElement('li');
          nuevoVersiculo.className = 'flex flex-col group relative';
          nuevoVersiculo.innerHTML = `
            <div class="relative w-full flex items-center">
              <input type="text" placeholder="Ej: Romanos 8:28" class="w-full text-gray-800 p-2 pr-10 rounded-md bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="${refValue}">
              <button class="eliminar-punto absolute right-2 top-1/2 -translate-y-1/2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="iconify text-xl" data-icon="material-symbols:delete-forever-rounded"></span>
              </button>
            </div>
            <div class="verse-text-display">${textValue}</div>
          `;
          listaVersículos.appendChild(nuevoVersiculo);
      };

      listaVersículos.addEventListener('blur', async (e) => {
          if (e.target && e.target.tagName === 'INPUT') {
              const input = e.target;
              const textDisplay = input.closest('li').querySelector('.verse-text-display');
              if (input.value.trim() === '') {
                  textDisplay.innerHTML = '';
                  saveToLocalStorage();
                  return;
              }
              textDisplay.innerHTML = 'Buscando...';
              const data = await fetchVerseData(input.value);
              if (data && textDisplay) {
                  textDisplay.innerHTML = data.map(v => `<span class="font-bold text-slate-800">${v.number}.</span> ${v.verse}`).join('<br>');
              } else if (textDisplay) {
                  textDisplay.innerHTML = '<span class="text-red-500">No se encontró la referencia.</span>';
              }
              saveToLocalStorage();
          }
      }, true); 


      listaVersículos.addEventListener('click', (e) => {
        if (e.target.closest('.eliminar-punto')) {
          e.target.closest('li').remove();
          saveToLocalStorage();
        }
      });
      botónAñadirVersiculo.addEventListener('click', () => {
        crearNuevoVersiculo();
        saveToLocalStorage();
      });

      const btnEvangelizar = document.getElementById('btn-evangelizar');
      const btnNuevaPrédica = document.getElementById('nueva-prédica-btn');
      const shareOptionsMenu = document.getElementById('share-options-menu');
      const closeShareMenuBtn = document.getElementById('close-share-menu-btn');
      const shareEvangelizacionBtn = document.getElementById('share-evangelizacion');
      const shareGuiaBtn = document.getElementById('share-guia');
      const shareEstudioBtn = document.getElementById('share-estudio');

      const openShareMenu = () => shareOptionsMenu.classList.add('open');
      const closeShareMenu = () => shareOptionsMenu.classList.remove('open');

      btnEvangelizar.addEventListener('click', openShareMenu);
      closeShareMenuBtn.addEventListener('click', closeShareMenu);

      shareEvangelizacionBtn.addEventListener('click', () => {
        const text = getFormattedContentEvangelizacion();
        window.open(`https://wa.me/?text=${text}`, '_blank');
        closeShareMenu();
      });

      shareGuiaBtn.addEventListener('click', () => {
        const text = getFormattedContentGuia();
        window.open(`https://wa.me/?text=${text}`, '_blank');
        closeShareMenu();
      });

      shareEstudioBtn.addEventListener('click', () => {
        const text = getFormattedContentEstudio();
        window.open(`https://wa.me/?text=${text}`, '_blank');
        closeShareMenu();
      });
      
      btnNuevaPrédica.addEventListener('click', () => {
        savePrédica();
        clearForm();
        updatePrédicasMenu();
        closeMenu();
      });

      prédicaContent.addEventListener('input', saveToLocalStorage);
      
      loadFromLocalStorage();
      updatePrédicasMenu();
    });
  </script>
</body>
</html>
