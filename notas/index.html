<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="multimedia/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        @font-face {
            font-family: 'Moderat';
            src: url('font/Moderat-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'Moderat';
            src: url('font/Moderat-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Moderat';
            src: url('font/Moderat-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Moderat';
            src: url('font/Moderat-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }
        * {
            font-family: 'Moderat', sans-serif;
            font-weight: normal;
            font-style: normal;
            box-sizing: border-box;
            outline: none;
        }
        :root {
            --green: #83DC5A;
            --dark-blue: #203855;
            --blue: #1D54C0;
            --light-blue: #A0C3EA;
            --extra-light-blue: #EDF5FF;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            background-color: #f5f5f5;
            background-image: linear-gradient(#eee 0.1em, transparent 0.1em);
            background-size: 100% 1.6em;
            line-height: 1.6;
            color: var(--dark-blue);
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .main-content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative;
        }
        .main-content-wrapper::before {
            content: "";
            position: absolute;
            top: 0;
            left: 40px;
            width: 2px;
            height: 100%;
            background-color: var(--extra-light-blue);
            z-index: -1;
        }
        textarea, input[type="text"] {
            background-color: transparent;
            border: none;
            border-bottom: 1px dashed var(--light-blue);
            border-radius: 0;
            padding: 4px 0;
            line-height: 1.6;
            color: var(--dark-blue);
            resize: none;
            min-height: 1.6rem;
            overflow: hidden;
        }
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-bottom: 1px solid var(--blue);
        }
        .slide-menu-bottom {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            transition: bottom 0.3s ease-in-out;
            z-index: 50;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .slide-menu-bottom.open {
            bottom: 0;
        }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
            backdrop-filter: blur(3px);
        }
        .menu-overlay.open {
            display: block;
        }
        .verse-text-display {
            font-size: 0.9rem;
            color: #475569;
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 3px solid var(--light-blue);
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: pre-wrap;
        }
        .section-title {
            position: relative;
            padding-left: 1.5rem;
        }
        .section-title:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 70%;
            width: 5px;
            background-color: var(--blue);
            border-radius: 5px;
        }
        .saved-sermon-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .saved-sermon-item:hover {
            border-left-color: var(--blue);
            background-color: #f8fafc;
        }
        #prédica-título {
            text-transform: uppercase;
        }
        .editable-point {
            background: transparent;
            border: none;
            outline: none;
            font-size: 1rem;
            line-height: 1.6;
            color: #000;
            position: relative;
            padding-bottom: 2px;
            min-height: 1.6rem;
            width: 100%;
            padding-top: 4px;
        }
        .editable-point-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            border-bottom: 1px dashed var(--light-blue);
        }
        .editable-point-wrapper:focus-within {
            border-bottom: 1px solid var(--blue);
        }
        .editable-point:empty:before {
            content: attr(data-placeholder);
            color: #9CA3AF;
            pointer-events: none;
            position: absolute;
            top: 4px;
            left: 0;
            font-style: normal;
        }
        .editable-point:focus:before {
            content: none;
        }
        .buttons-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            z-index: 30;
        }
        .buttons-footer button {
            background-color: var(--extra-light-blue);
            color: var(--dark-blue);
            padding: 1rem;
            border-radius: 9999px;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .buttons-footer button:hover {
            background-color: var(--light-blue);
            color: #fff;
        }
        textarea::-webkit-scrollbar,
        input::-webkit-scrollbar,
        div::-webkit-scrollbar {
            display: none;
        }
        textarea, input, div {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <title>Apuntes | IBBV</title>
</head>
<body>

<div id="slide-menu" class="slide-menu-bottom">
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
        <h3 class="text-2xl font-bold text-dark-blue">Prédicas</h3>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800 transition-colors">
            <span class="iconify text-2xl" data-icon="clarity:close-line"></span>
        </button>
    </div>
    <ul id="prédicas-guardadas-lista" class="space-y-3"></ul>
    <div class="text-center mt-6 pt-4 border-t border-gray-200">
        <button id="limpiar-todo-btn" class="bg-[var(--blue)] text-white hover:bg-[var(--light-blue)] transition-colors flex items-center justify-center py-3 rounded-full w-[90%] mx-auto font-medium">
            <span class="flex items-center justify-center">
                <span class="iconify mr-1" data-icon="mdi:trash-can-outline"></span>
                <span>Limpiar todas</span>
            </span>
        </button>
    </div>
</div>
<div id="menu-overlay" class="menu-overlay"></div>

<div class="main-content-wrapper">
    <header class="text-center relative py-6">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                <textarea id="prédica-título" placeholder="Título de la Prédica" class="w-full text-center p-2 font-bold text-2xl md:text-3xl text-gray-900" rows="1"></textarea>
            </h1>
            <p class="text-lg text-gray-600">Por:
                <input type="text" id="predicador-nombre" placeholder="Nombre del Predicador" class="bg-transparent p-2 text-gray-600 text-base md:text-lg text-center font-medium">
            </p>
            <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-gray-500 mt-4 text-sm">
                <div class="flex items-center px-3 py-1">
                    <span class="iconify mr-2 text-gray-500" data-icon="clarity:date-solid"></span>
                    <span id="fecha-actual" class="font-medium"></span>
                </div>
                <div class="flex items-center px-3 py-1">
                    <span class="iconify mr-2 text-gray-500" data-icon="weui:time-filled"></span>
                    <span id="hora-actual" class="font-medium"></span>
                </div>
                <div class="flex items-center px-3 py-1">
                    <span class="iconify mr-2 text-gray-500" data-icon="ic:baseline-location-on"></span>
                    <span class="font-medium">IBB La Verdad</span>
                </div>
            </div>
        </div>
    </header>

    <main class="space-y-8">
        <section>
            <div class="text-center w-full">
                <p class="text-gray-600 text-sm uppercase tracking-wide font-semibold mb-3">Versículo Principal</p>
                <input type="text" id="pasaje-principal" placeholder="Juan 3:16" class="w-full text-center p-3 font-bold text-xl md:text-2xl text-gray-900 mb-3">
                <div id="cita-pasaje-container"></div>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-bold text-gray-700 mb-4 section-title">Notas</h2>
            <ul id="puntos-lista" class="space-y-3"></ul>
            <div class="flex gap-4 mt-5">
                <button id="añadir-punto" class="flex-grow bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                    <span class="iconify mr-2" data-icon="mdi:plus"></span>
                    Añadir Nota
                </button>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-bold text-gray-700 mb-4 section-title">Versículos</h2>
            <ul id="versículos-citados-lista" class="space-y-4"></ul>
            <button id="añadir-versiculo" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                    <span class="iconify mr-2" data-icon="mdi:plus"></span>
                    Añadir Versículo
            </button>
        </section>
    </main>
</div>

<footer class="buttons-footer">
    <button id="open-menu-btn" class="open-menu-btn">
        <span class="iconify text-2xl" data-icon="material-symbols:menu-book-outline"></span>
    </button>
    <button id="nueva-prédica-btn">
        <span class="iconify text-2xl" data-icon="mdi:plus"></span>
    </button>
    <button id="fullscreen-btn" class="fullscreen-btn">
        <span class="iconify text-2xl" data-icon="ic:baseline-fullscreen"></span>
    </button>
    <button id="share-whatsapp-btn">
        <span class="iconify text-2xl" data-icon="ic:outline-whatsapp"></span>
    </button>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const prédicaContent = document.querySelector('.main-content-wrapper');
        const slideMenu = document.getElementById('slide-menu');
        const openMenuBtn = document.getElementById('open-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuOverlay = document.getElementById('menu-overlay');
        const listaPrédicasGuardadas = document.getElementById('prédicas-guardadas-lista');
        const btnLimpiarTodo = document.getElementById('limpiar-todo-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const citaPasajeContainer = document.getElementById('cita-pasaje-container');
        const shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
        
        let currentPrédicaId = null;

        // --- INICIO: LÓGICA PARA MANTENER PANTALLA ENCENDIDA ---
        let wakeLock = null;
        let wakeLockTimer = null;
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator && document.visibilityState === 'visible') {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock está activo.');
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock fue liberado.');
                        wakeLock = null;
                    });
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
        };

        const releaseWakeLock = () => {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            if (wakeLockTimer) {
                clearTimeout(wakeLockTimer);
                wakeLockTimer = null;
            }
        };

        const resetWakeLockTimer = async () => {
            if (wakeLockTimer) clearTimeout(wakeLockTimer);
            if (!wakeLock) await requestWakeLock();
            wakeLockTimer = setTimeout(() => releaseWakeLock(), 600000);
        };

        ['click', 'input', 'scroll'].forEach(evt => document.addEventListener(evt, resetWakeLockTimer));
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                resetWakeLockTimer();
            } else {
                releaseWakeLock();
            }
        });
        // --- FIN: LÓGICA PARA MANTENER PANTALLA ENCENDIDA ---

        const books = [
            { name: "Génesis", abrev: "GN" }, { name: "Éxodo", abrev: "EX" }, { name: "Levítico", abrev: "LV" },
            { name: "Números", abrev: "NM" }, { name: "Deuteronomio", abrev: "DT" }, { name: "Josué", abrev: "JOS" },
            { name: "Jueces", abrev: "JUE" }, { name: "Rut", abrev: "RT" }, { name: "1-Samuel", abrev: "1S" },
            { name: "2-Samuel", abrev: "2S" }, { name: "1-Reyes", abrev: "1R" }, { name: "2-Reyes", abrev: "2R" },
            { name: "1-Crónicas", abrev: "1CR" }, { name: "2-Crónicas", abrev: "2CR" }, { name: "Esdras", abrev: "ESD" },
            { name: "Nehemías", abrev: "NEH" }, { name: "Ester", abrev: "EST" }, { name: "Job", abrev: "JOB" },
            { name: "Salmos", abrev: "SAL" }, { name: "Proverbios", abrev: "PR" }, { name: "Eclesiastés", abrev: "EC" },
            { name: "Cantares", abrev: "CNT" }, { name: "Isaías", abrev: "IS" }, { name: "Jeremías", abrev: "JER" },
            { name: "Lamentaciones", abrev: "LM" }, { name: "Ezequiel", abrev: "EZ" }, { name: "Daniel", abrev: "DN" },
            { name: "Oseas", abrev: "OS" }, { name: "Joel", abrev: "JL" }, { name: "Amós", abrev: "AM" },
            { name: "Abdías", abrev: "ABD" }, { name: "Jonás", abrev: "JON" }, { name: "Miqueas", abrev: "MI" },
            { name: "Nahúm", abrev: "NAH" }, { name: "Habacuc", abrev: "HAB" }, { name: "Sofonías", abrev: "SOF" },
            { name: "Hageo", abrev: "HAG" }, { name: "Zacarías", abrev: "ZAC" }, { name: "Malaquías", abrev: "MAL" },
            { name: "Mateo", abrev: "MT" }, { name: "Marcos", abrev: "MR" }, { name: "Lucas", abrev: "LC" },
            { name: "Juan", abrev: "JN" }, { name: "Hechos", abrev: "HCH" }, { name: "Romanos", abrev: "RO" },
            { name: "1-Corintios", abrev: "1CO" }, { name: "2-Corintios", abrev: "2CO" }, { name: "Gálatas", abrev: "GA" },
            { name: "Efesios", abrev: "EF" }, { name: "Filipenses", abrev: "FIL" }, { name: "Colosenses", abrev: "COL" },
            { name: "1-Tesalonicenses", abrev: "1TS" }, { name: "2-Tesalonicenses", abrev: "2TS" },
            { name: "1-Timoteo", abrev: "1TI" }, { name: "2-Timoteo", abrev: "2TI" }, { name: "Tito", abrev: "TIT" },
            { name: "Filemón", abrev: "FLM" }, { name: "Hebreos", abrev: "HE" }, { name: "Santiago", abrev: "STG" },
            { name: "1-Pedro", abrev: "1P" }, { name: "2-Pedro", abrev: "2P" }, { name: "1-Juan", abrev: "1JN" },
            { name: "2-Juan", abrev: "2JN" }, { name: "3-Juan", abrev: "3JN" }, { name: "Judas", abrev: "JUD" },
            { name: "Apocalipsis", abrev: "AP" }
        ];

        function findBookAbrev(bookName) {
            const normalizedName = bookName.toLowerCase().replace(/[\s-]/g, '');
            for (const book of books) {
                const normalizedBookName = book.name.toLowerCase().replace(/[\s-]/g, '');
                if (normalizedBookName.includes(normalizedName)) {
                    return book.abrev;
                }
            }
            return null;
        }

        function parseInput(input) {
            const regex = /(.+?)\s*(\d+):(\d+)(?:-(\d+))?$/i;
            const match = input.trim().match(regex);
            if (match) {
                const bookName = match[1].trim();
                const chapter = match[2];
                const verse = match[3];
                const verseEnd = match[4];
                return { book: bookName, chapter, verse, verseEnd };
            }
            return null;
        }

        async function fetchVerseData(reference) {
            const trimmedRef = reference.trim();
            if (!trimmedRef) return null;
            try {
                const parsed = parseInput(trimmedRef);
                if (!parsed) { throw new Error('Formato de referencia inválido.'); }
                const bookAbrev = findBookAbrev(parsed.book);
                if (!bookAbrev) { throw new Error(`Libro no encontrado: ${parsed.book}`); }
                let verseRange = parsed.verse;
                if (parsed.verseEnd) {
                    verseRange += `-${parsed.verseEnd}`;
                }
                const url = `https://bible-api.deno.dev/api/read/rv1960/${bookAbrev}/${parsed.chapter}/${verseRange}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Error en la API');
                }
                const data = await response.json();
                const dataAsArray = Array.isArray(data) ? data : [data];
                if (dataAsArray.length === 0) { throw new Error('Versículo no encontrado.'); }
                return dataAsArray;
            } catch (error) {
                console.error(`Error al buscar "${trimmedRef}":`, error);
                return null;
            }
        }

        const autoResizeTextarea = (textarea) => {
            if(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        };

        const pasajePrincipalInput = document.getElementById('pasaje-principal');
        const tituloPrédicaTextarea = document.getElementById('prédica-título');

        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                autoResizeTextarea(e.target);
                saveToLocalStorage();
            });
            autoResizeTextarea(textarea);
        });

        tituloPrédicaTextarea.addEventListener('input', (e) => {
            autoResizeTextarea(e.target);
            saveToLocalStorage();
        });
        autoResizeTextarea(tituloPrédicaTextarea);

        pasajePrincipalInput.addEventListener('blur', async () => {
            const data = await fetchVerseData(pasajePrincipalInput.value);
            if (data) {
                const verseText = data.map(v => `<span class="font-bold text-gray-800">${v.number}.</span> ${v.verse}`).join('<br>');
                citaPasajeContainer.innerHTML = `<div class="verse-text-display">${verseText}</div>`;
                saveToLocalStorage();
            } else {
                citaPasajeContainer.innerHTML = '';
            }
        });

        const openMenu = () => {
            slideMenu.classList.add('open');
            menuOverlay.classList.add('open');
        };
        const closeMenu = () => {
            slideMenu.classList.remove('open');
            menuOverlay.classList.remove('open');
        };

        openMenuBtn.addEventListener('click', openMenu);
        closeMenuBtn.addEventListener('click', closeMenu);
        menuOverlay.addEventListener('click', closeMenu);

        const saveToLocalStorage = () => {
            const versiculosData = [];
            document.querySelectorAll('#versículos-citados-lista li').forEach(li => {
                const input = li.querySelector('input');
                const textDiv = li.querySelector('.verse-text-display');
                if (input) {
                    versiculosData.push({
                        ref: input.value,
                        text: textDiv ? textDiv.innerHTML : ''
                    });
                }
            });

            const puntosContent = Array.from(document.querySelectorAll('#puntos-lista .editable-point')).map(div => {
                return div.textContent;
            });

            const data = {
                title: document.getElementById('prédica-título').value,
                predicador: document.getElementById('predicador-nombre').value,
                pasajePrincipal: document.getElementById('pasaje-principal').value,
                citaPasaje: citaPasajeContainer.innerHTML,
                puntos: puntosContent,
                versiculos: versiculosData,
                id: currentPrédicaId
            };
            localStorage.setItem('currentPrédicaData', JSON.stringify(data));
        };

        const loadFromLocalStorage = () => {
            const data = JSON.parse(localStorage.getItem('currentPrédicaData'));
            if (data) {
                fillForm(data);
                currentPrédicaId = data.id || null;
            } else {
                clearForm();
            }
        };

        const clearForm = () => {
            prédicaContent.querySelectorAll('input[type="text"], textarea').forEach(input => input.value = '');
            document.getElementById('puntos-lista').innerHTML = '';
            document.getElementById('versículos-citados-lista').innerHTML = '';
            citaPasajeContainer.innerHTML = '';
            currentPrédicaId = null;
            saveToLocalStorage();
        };

        const savePrédica = () => {
            const title = document.getElementById('prédica-título').value.trim() || 'Sin Título';
            const date = document.getElementById('fecha-actual').textContent;

            // Si ya hay un ID, actualiza la prédica existente
            if (currentPrédicaId) {
                const existingKey = Object.keys(localStorage).find(key => key.includes(`-${currentPrédicaId}`));
                if (existingKey) {
                    localStorage.removeItem(existingKey);
                }
            } else {
                // Si no hay ID, crea uno nuevo
                currentPrédicaId = Date.now();
            }
            
            const key = `prédica-${title}-${date}-${currentPrédicaId}`;
            saveToLocalStorage();
            const currentData = JSON.parse(localStorage.getItem('currentPrédicaData'));

            if (currentData) {
                currentData.title = title;
                currentData.date = date;
                currentData.id = currentPrédicaId;
                localStorage.setItem(key, JSON.stringify(currentData));
                updatePrédicasMenu();
            }
        };

        const fillForm = (data) => {
            document.getElementById('prédica-título').value = data.title || '';
            document.getElementById('predicador-nombre').value = data.predicador || '';
            document.getElementById('pasaje-principal').value = data.pasajePrincipal || '';
            citaPasajeContainer.innerHTML = data.citaPasaje || '';

            document.querySelectorAll('textarea').forEach(textarea => {
                autoResizeTextarea(textarea);
            });

            listaPuntos.innerHTML = '';
            if (data.puntos && data.puntos.length > 0) {
                data.puntos.forEach(value => crearNuevoPunto(value));
            }

            listaVersículos.innerHTML = '';
            if (data.versiculos && data.versiculos.length > 0) {
                data.versiculos.forEach(v => crearNuevoVersiculo(v.ref, v.text));
            }
        };

        const updatePrédicasMenu = () => {
            listaPrédicasGuardadas.innerHTML = '';
            const prédicaKeys = Object.keys(localStorage).filter(key => key.startsWith('prédica-'));

            // Ordena las prédicas por ID (la más nueva primero)
            prédicaKeys.sort((a, b) => {
                const timestampA = parseInt(a.split('-').pop());
                const timestampB = parseInt(b.split('-').pop());
                return timestampB - timestampA;
            });

            if (prédicaKeys.length === 0) {
                listaPrédicasGuardadas.innerHTML = '<li class="text-gray-500 text-center py-4 text-sm">No hay prédicas guardadas.</li>';
                btnLimpiarTodo.style.display = 'none';
            } else {
                btnLimpiarTodo.style.display = 'block';
                prédicaKeys.forEach(key => {
                    const data = JSON.parse(localStorage.getItem(key));
                    const li = document.createElement('li');
                    li.className = 'saved-sermon-item p-3 rounded-lg flex justify-between items-center transition-colors cursor-pointer border-l-4 border-transparent hover:border-[var(--blue)] hover:bg-[#f8fafc]';
                    li.dataset.key = key;
                    li.innerHTML = `
                        <div class="flex justify-between items-center w-full" data-key="${key}">
                            <div>
                                <p class="font-semibold text-gray-800">${data.title}</p>
                                <p class="text-sm text-gray-500">${data.date}</p>
                            </div>
                            <button class="eliminar-prédica text-[var(--dark-blue)] hover:text-[var(--blue)] ml-4">
                                <span class="iconify" data-icon="material-symbols:delete-forever-rounded"></span>
                            </button>
                        </div>
                    `;
                    listaPrédicasGuardadas.appendChild(li);
                });
            }
        };

        listaPrédicasGuardadas.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.eliminar-prédica');
            if (deleteButton) {
                e.stopPropagation();
                const key = deleteButton.closest('li').dataset.key;
                localStorage.removeItem(key);
                updatePrédicasMenu();
                // Si la prédica actual es la que se eliminó, limpiar el formulario
                const idFromKey = parseInt(key.split('-').pop());
                if(currentPrédicaId === idFromKey) {
                    clearForm();
                }
                return;
            }
            const target = e.target.closest('li[data-key]');
            if (target) {
                const key = target.dataset.key;
                const data = JSON.parse(localStorage.getItem(key));
                if (data) {
                    fillForm(data);
                    currentPrédicaId = data.id;
                    localStorage.setItem('currentPrédicaData', JSON.stringify(data));
                    closeMenu();
                }
            }
        });

        btnLimpiarTodo.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres eliminar TODAS las prédicas guardadas? Esta acción no se puede deshacer.')) {
                Object.keys(localStorage).filter(key => key.startsWith('prédica-')).forEach(key => {
                    localStorage.removeItem(key);
                });
                clearForm();
                updatePrédicasMenu();
            }
        });

        const fechaElement = document.getElementById('fecha-actual');
        const horaElement = document.getElementById('hora-actual');

        const updateDateTime = () => {
            const ahora = new Date();
            const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
            const opcionesHora = { hour: '2-digit', minute: '2-digit' };
            fechaElement.textContent = ahora.toLocaleDateString('es-ES', opcionesFecha);
            horaElement.textContent = ahora.toLocaleTimeString('es-ES', opcionesHora);
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);

        const listaPuntos = document.getElementById('puntos-lista');
        const botónAñadirPunto = document.getElementById('añadir-punto');
        let contadorPuntos = 0;

        const crearNuevoPunto = (value = '') => {
            const nuevoPunto = document.createElement('li');
            nuevoPunto.className = 'flex items-start group';
            
            nuevoPunto.innerHTML = `
                <div class="flex-grow flex items-start p-2 rounded-lg editable-point-wrapper">
                    <div contenteditable="true" data-placeholder="Escribe aquí tu nota" class="editable-point w-full text-base leading-relaxed text-black relative min-h-[1.6rem] py-1 outline-none">${value}</div>
                    <span class="point-number-text text-gray-500 font-medium text-sm ml-2 select-none"></span>
                </div>
                <button class="eliminar-punto text-[var(--dark-blue)] hover:text-[var(--blue)] ml-1 p-2 self-center">
                    <span class="iconify text-xl" data-icon="material-symbols:delete-forever-rounded"></span>
                </button>
            `;
            listaPuntos.appendChild(nuevoPunto);

            const editableDiv = nuevoPunto.querySelector('.editable-point');
            editableDiv.addEventListener('input', saveToLocalStorage);
            editableDiv.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const allPoints = Array.from(listaPuntos.querySelectorAll('.editable-point'));
                    const currentIndex = allPoints.indexOf(editableDiv);
                    if (currentIndex < allPoints.length - 1) {
                        allPoints[currentIndex + 1].focus();
                    } else {
                        botónAñadirPunto.click();
                        setTimeout(() => listaPuntos.querySelector('.editable-point:last-child').focus(), 0);
                    }
                }
            });
            reordenarPuntos();
        };

        const reordenarPuntos = () => {
            const puntos = listaPuntos.querySelectorAll('li');
            puntos.forEach((punto, index) => {
                punto.querySelector('.point-number-text').textContent = `[${index + 1}]`;
            });
            contadorPuntos = puntos.length;
        };

        listaPuntos.addEventListener('click', (e) => {
            if (e.target.closest('.eliminar-punto')) {
                e.target.closest('li').remove();
                reordenarPuntos();
                saveToLocalStorage();
            }
        });

        botónAñadirPunto.addEventListener('click', () => {
            crearNuevoPunto();
            saveToLocalStorage();
        });

        const listaVersículos = document.getElementById('versículos-citados-lista');
        const botónAñadirVersiculo = document.getElementById('añadir-versiculo');

        const crearNuevoVersiculo = (refValue = '', textValue = '') => {
            const nuevoVersiculo = document.createElement('li');
            nuevoVersiculo.className = 'flex flex-col relative space-y-2';
            nuevoVersiculo.innerHTML = `
                <div class="relative w-full flex items-center space-x-2">
                    <input type="text" placeholder="Romanos 8:28" class="flex-grow text-gray-800 p-3" value="${refValue}">
                    <button class="convert-to-main-verse text-[var(--dark-blue)] hover:text-[var(--blue)] p-2" title="Hacer Versículo Principal">
                        <span class="iconify text-xl" data-icon="mdi:star-outline"></span>
                    </button>
                    <button class="eliminar-punto text-[var(--dark-blue)] hover:text-[var(--blue)] p-2">
                        <span class="iconify text-xl" data-icon="material-symbols:delete-forever-rounded"></span>
                    </button>
                </div>
                <div class="verse-text-display ${textValue ? '' : 'hidden'}">${textValue}</div>
            `;
            listaVersículos.appendChild(nuevoVersiculo);
            const textDisplay = nuevoVersiculo.querySelector('.verse-text-display');
        };

        listaVersículos.addEventListener('blur', async (e) => {
            if (e.target && e.target.tagName === 'INPUT') {
                const input = e.target;
                const textDisplay = input.closest('li').querySelector('.verse-text-display');
                if (input.value.trim() === '') {
                    textDisplay.innerHTML = '';
                    textDisplay.classList.add('hidden');
                    saveToLocalStorage();
                    return;
                }
                textDisplay.classList.remove('hidden');
                textDisplay.innerHTML = 'Buscando...';
                const data = await fetchVerseData(input.value);
                if (data) {
                    textDisplay.innerHTML = data.map(v => `<span class="font-bold text-gray-800">${v.number}.</span> ${v.verse}`).join('<br>');
                } else {
                    textDisplay.innerHTML = '<span class="text-[var(--dark-blue)]">No se encontró la referencia.</span>';
                }
                saveToLocalStorage();
            }
        }, true);

        listaVersículos.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.eliminar-punto');
            if (deleteButton) {
                deleteButton.closest('li').remove();
                saveToLocalStorage();
                return;
            }

            const convertButton = e.target.closest('.convert-to-main-verse');
            if (convertButton) {
                const listItem = convertButton.closest('li');
                const refInput = listItem.querySelector('input');
                const textDisplay = listItem.querySelector('.verse-text-display');

                if (refInput.value && textDisplay.innerHTML && !textDisplay.querySelector('.text-[var(--dark-blue)]')) {
                    const currentPrincipalRef = document.getElementById('pasaje-principal').value;
                    const currentPrincipalText = citaPasajeContainer.innerHTML;

                    if (currentPrincipalRef && currentPrincipalText) {
                        crearNuevoVersiculo(currentPrincipalRef, currentPrincipalText);
                    }

                    document.getElementById('pasaje-principal').value = refInput.value;
                    citaPasajeContainer.innerHTML = textDisplay.innerHTML;

                    listItem.remove();
                    saveToLocalStorage();
                }
            }
        });
        botónAñadirVersiculo.addEventListener('click', () => {
            crearNuevoVersiculo();
            saveToLocalStorage();
        });

        const btnNuevaPrédica = document.getElementById('nueva-prédica-btn');

        btnNuevaPrédica.addEventListener('click', () => {
            savePrédica();
            clearForm();
            updatePrédicasMenu();
            closeMenu();
        });

        prédicaContent.addEventListener('input', () => {
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(saveToLocalStorage, 2000);
        });

        loadFromLocalStorage();
        updatePrédicasMenu();

        function toggleFullscreen() {
            const docElm = document.documentElement;
            if (!document.fullscreenElement) {
                docElm.requestFullscreen().catch(err => {
                    alert(`Error al intentar entrar en pantalla completa: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        fullscreenBtn.addEventListener('click', toggleFullscreen);

        document.addEventListener('fullscreenchange', () => {
            const icon = fullscreenBtn.querySelector('.iconify');
            if (document.fullscreenElement) {
                icon.setAttribute('data-icon', 'ic:baseline-fullscreen-exit');
            } else {
                icon.setAttribute('data-icon', 'ic:baseline-fullscreen');
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11' || (e.key === 'f' && !e.ctrlKey && !e.shiftKey && !e.altKey)) {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        // FIX PARA EL TECLADO EN PANTALLA COMPLETA
        const inputsAndTextareas = document.querySelectorAll('input[type="text"], textarea');
        inputsAndTextareas.forEach(element => {
            element.addEventListener('focus', () => {
                // Si está en pantalla completa, hace scroll para que el input sea visible.
                if (document.fullscreenElement) {
                    setTimeout(() => {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300); // Pequeño retraso para que el teclado tenga tiempo de aparecer
                }
            });
        });

        // --- LÓGICA DEL BOTÓN DE COMPARTIR A WHATSAPP ---
        shareWhatsappBtn.addEventListener('click', () => {
            const title = document.getElementById('prédica-título').value.trim();
            const predicador = document.getElementById('predicador-nombre').value.trim();
            const pasajePrincipal = document.getElementById('pasaje-principal').value.trim();
            const citaPasaje = citaPasajeContainer.textContent.trim();
            
            const puntos = Array.from(document.querySelectorAll('#puntos-lista .editable-point'))
                                .filter(div => div.textContent.trim())
                                .map((div, index) => {
                                    const text = div.textContent.trim();
                                    return `${index + 1}. ${text}`;
                                }).join('\n');

            const versiculosCitados = Array.from(document.querySelectorAll('#versículos-citados-lista li'))
                                            .map(li => {
                                                const ref = li.querySelector('input').value.trim();
                                                const text = li.querySelector('.verse-text-display').textContent.trim();
                                                if (ref && text && !text.includes('No se encontró')) {
                                                    return `*${ref}*\n_${text}_`;
                                                }
                                                return '';
                                            }).filter(line => line).join('\n\n');

            let message = '';

            if (title) {
                message += `*${title.toUpperCase()}*\n`;
            }
            if (predicador) {
                message += `Por: _${predicador}_\n`;
            }
            if (pasajePrincipal && citaPasaje) {
                message += `\n*Versículo Principal:*\n*${pasajePrincipal}*\n_${citaPasaje}_\n`;
            }
            if (puntos) {
                message += `\n*Notas:*\n${puntos}\n`;
            }
            if (versiculosCitados) {
                message += `\n*Versículos:*\n${versiculosCitados}\n`;
            }

            if (message.trim() === '') {
                alert('No hay contenido para compartir.');
                return;
            }

            const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });
    });
</script>
</body>
</html>